parameters:

services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\:
        resource: "../src/"
        exclude:
            - "../src/Kernel.php"

    App\Contexts\Shared\Infrastructure\Symfony\ExceptionListener:
        tags:
            - { name: "kernel.event_listener", event: "kernel.exception" }

    App\Contexts\Shared\Infrastructure\Symfony\EventListener\ValidationExceptionListener:
        tags:
            - {
                  name: "kernel.event_listener",
                  event: "kernel.exception",
                  priority: 10,
              }

    App\Contexts\Shared\Infrastructure\Symfony\JwtAuthMiddleware:
        tags:
            - {
                  name: kernel.event_listener,
                  event: kernel.request,
                  method: onKernelRequest,
              }

    App\Contexts\Shared\Infrastructure\Symfony\JwtAdminAuthMiddleware:
        tags:
            - {
                  name: kernel.event_listener,
                  event: kernel.request,
                  method: onKernelRequest,
              }

    # Configure
    _instanceof:
        App\Contexts\Shared\Domain\CQRS\Event\DomainEventSubscriber:
            tags:
                - "app.domain_event_subscriber"
                - {
                      name: "messenger.message_handler",
                      bus: "messenger.bus.default",
                  }

        App\Contexts\Shared\Domain\CQRS\Command\CommandHandler:
            tags: ["app.command_handler"]

        App\Contexts\Shared\Domain\CQRS\Query\QueryHandler:
            tags: ["app.query_handler"]

    #Tagging
    App\Contexts\Shared\Infrastructure\CQRS\Event\InMemory\InMemorySymfonyEventBus:
        arguments: [!tagged_iterator app.domain_event_subscriber]
        lazy: true

    App\Contexts\Shared\Infrastructure\CQRS\Event\DomainEventMapping:
        arguments: [!tagged_iterator app.domain_event_subscriber]

    App\Contexts\Shared\Infrastructure\CQRS\Event\DomainEventSubscriberLocator:
        arguments: [!tagged_iterator app.domain_event_subscriber]

    App\Contexts\Shared\Infrastructure\Symfony\AddJsonBodyToRequestListener:
        tags:
            - {
                  name: kernel.event_listener,
                  event: kernel.request,
                  method: onKernelRequest,
              }

    # -- APP DEFINITIONS --
    # Command/Query Handlers
    App\Contexts\Shared\Infrastructure\CQRS\Command\InMemorySymfonyCommandBus:
        arguments: [!tagged_iterator app.command_handler]

    App\Contexts\Shared\Infrastructure\CQRS\Query\InMemorySymfonyQueryBus:
        arguments: [!tagged_iterator app.query_handler]

    # Event Bus - uses Messenger for async event processing via RabbitMQ
    App\Contexts\Shared\Infrastructure\CQRS\Event\Messenger\MessengerEventBus:
        arguments:
            $messageBus: "@messenger.default_bus"

    App\Contexts\Shared\Domain\CQRS\Event\EventBus: '@App\Contexts\Shared\Infrastructure\CQRS\Event\Messenger\MessengerEventBus'

    # Email Configuration
    App\Contexts\Shared\Domain\Email\EmailSender: '@App\Contexts\Shared\Infrastructure\Email\SymfonyEmailSender'

    App\Contexts\Shared\Infrastructure\Email\SymfonyEmailSender:
        arguments:
            $fromEmail: "%env(MAILER_FROM_EMAIL)%"
            $fromName: "%env(MAILER_FROM_NAME)%"

    App\Contexts\Web\User\Application\SendEmailConfirmation\EmailConfirmationSender:
        arguments:
            $appUrl: "%env(APP_URL)%"

    App\Contexts\Web\User\Application\ResendEmailConfirmation\EmailConfirmationResender:
        arguments:
            $appUrl: "%env(APP_URL)%"

    App\Contexts\Web\Auth\Application\ForgotPassword\PasswordResetRequestor:
        arguments:
            $appUrl: "%env(APP_URL)%"

    # HTTP Client Configuration
    App\Contexts\Shared\Domain\Http\HttpClient: '@App\Contexts\Shared\Infrastructure\Http\SymfonyHttpClient'

    # Riot Games API Configuration (League of Legends)
    App\Contexts\Web\Player\Infrastructure\RankVerification\Riot\RiotApiClient:
        arguments:
            $apiKey: "%env(RIOT_API_KEY)%"

    # Henrik API Configuration (Valorant)
    App\Contexts\Web\Player\Infrastructure\RankVerification\Henrik\HenrikApiClient:
        arguments:
            $apiKey: "%env(HENRIK_API_KEY)%"

    # Tracker.gg API Configuration (CS2)
    App\Contexts\Web\Player\Infrastructure\RankVerification\TrackerGg\TrackerGgApiClient:
        arguments:
            $apiKey: "%env(TRACKER_GG_API_KEY)%"

    # OpenDota API Configuration (Dota 2)
    App\Contexts\Web\Player\Infrastructure\RankVerification\OpenDota\OpenDotaApiClient:
        arguments:
            $apiKey: "%env(OPENDOTA_API_KEY)%"

    # Hashtag Repository
    App\Contexts\Web\Post\Domain\HashtagRepository: '@App\Contexts\Web\Post\Infrastructure\Persistence\MysqlHashtagRepository'

    # Post Moderation - OpenAI Text Moderation
    App\Contexts\Web\Post\Infrastructure\Moderation\OpenAi\OpenAiTextModerationService:
        arguments:
            $apiKey: "%env(OPENAI_API_KEY)%"

    App\Contexts\Web\Post\Domain\Moderation\TextModerationService: '@App\Contexts\Web\Post\Infrastructure\Moderation\OpenAi\OpenAiTextModerationService'

    # Post Moderation - OpenAI Image Moderation
    App\Contexts\Web\Post\Infrastructure\Moderation\OpenAi\OpenAiImageModerationService:
        arguments:
            $apiKey: "%env(OPENAI_API_KEY)%"

    App\Contexts\Web\Post\Domain\Moderation\ImageModerationService: '@App\Contexts\Web\Post\Infrastructure\Moderation\OpenAi\OpenAiImageModerationService'

    # Console Commands
    App\Apps\Console\MigrateProfileImagesToNewStructureCommand:
        arguments:
            $projectDir: "%kernel.project_dir%"

    App\Apps\Console\CleanupOldR2FolderCommand:
        arguments:
            $r2Endpoint: "https://ac9d6074e82dd52cd950e48478da4a54.r2.cloudflarestorage.com"
            $r2Region: "%env(AWS_S3_REGION)%"
            $r2AccessKey: "%env(AWS_S3_ACCESS_KEY)%"
            $r2SecretKey: "%env(AWS_S3_ACCESS_SECRET)%"

    # CDN Base URL for avatar URLs
    App\Contexts\Web\User\Application\Search\UserSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\User\Application\Find\UserFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\User\Application\FindUserByUsername\UserByUsernameFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\User\Application\Followers\UserFollowersFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\User\Application\Followings\UserFollowingsFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\User\Application\FindBackgroundImage\UserBackgroundImageFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Post Context - CDN Base URL
    App\Contexts\Web\Post\Application\SearchPostComments\PostCommentSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\Search\PostSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\SearchMyFeed\MyFeedSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\FindBatch\PostsBatchFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\Find\PostFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\SearchPostShares\PostSharesSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\SearchPostLikes\PostLikesSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\Shared\GetPostResources:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Conversation Context - CDN Base URL
    App\Contexts\Web\Conversation\Application\FindConversations\ConversationsFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Team Context - CDN Base URL
    App\Contexts\Web\Team\Application\FindMembers\TeamMembersFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\Find\FindTeamQueryHandler:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\Search\SearchTeamsQueryHandler:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\FindBackgroundImage\TeamBackgroundImageFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Tournament Context - CDN Base URL
    App\Contexts\Web\Tournament\Application\Find\FindTournamentQueryHandler:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Tournament\Application\Search\SearchTournamentsQueryHandler:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Tournament\Application\FindBackgroundImage\TournamentBackgroundImageFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Notification Context - CDN Base URL
    App\Contexts\Web\Notification\Application\Search\NotificationSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\SearchRosterPlayers\RosterPlayersSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\SearchRosters\RostersSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Team\Application\FindRoster\RosterFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Event Context - CDN Base URL
    App\Contexts\Web\Event\Application\Find\EventFinder:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Event\Application\Search\EventsSearcher:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    App\Contexts\Web\Post\Application\Moderation\PostImageModerator:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"

    # Video Processing - FFmpeg Services
    App\Contexts\Web\Post\Domain\Video\VideoValidator: '@App\Contexts\Web\Post\Infrastructure\Video\FFmpegVideoValidator'
    App\Contexts\Web\Post\Domain\Video\VideoFrameExtractor: '@App\Contexts\Web\Post\Infrastructure\Video\FFmpegFrameExtractor'
    App\Contexts\Web\Post\Domain\Video\VideoTranscoder: '@App\Contexts\Web\Post\Infrastructure\Video\FFmpegVideoTranscoder'

    # Video Moderation - CDN Base URL
    App\Contexts\Web\Post\Application\Video\Moderation\PostVideoModerator:
        arguments:
            $cdnBaseUrl: "%env(R2_PUBLIC_URL)%"
